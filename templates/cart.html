{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- CSS -->
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
        <script>
          window.onload = function (){
            var cart = localStorage.length;
            var cartid = document.getElementById('crtno');
            cartid.innerText = cart;
          }
        </script>
  
    </head>
    <body>
    <div>
    <nav class="navbar navbar-light bg-white justify-content-center zz-nav-header">
    <a class="navbar-brand" href="#">
        <img src="zeus logo (1).png"  alt="" loading="lazy">
    </a>
    </nav>
    <nav class="nav my-2 my-lg-2 bg-light d-flex justify-content-between">
      <div class="d-flex justify-content-start">
        <a class="nav-link text-dark  my-4 " href="#">Home</a>
        <a class="nav-link text-dark my-4 " href="{% url 'collection' %}">Product</a>
      </div>
      <div class="d-flex justify-content-end mr-3">
        <a class="nav-link text-dark  my-4 " href="#"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-search" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M10.442 10.442a1 1 0 0 1 1.415 0l3.85 3.85a1 1 0 0 1-1.414 1.415l-3.85-3.85a1 1 0 0 1 0-1.415z"/>
          <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
        </svg> Search</a>
        <div class="dropdown">
          <a class="nav-link text-dark  my-4 "  id="my-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"  href="#"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-person-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
          </svg> Account</a>
          <div class="dropdown-menu" aria-labelledby="my-dropdown">
            {% if user.is_authenticated %}
            <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
            <span style="display: none;" id="cusid">{{user.id}}</span>  
            {% else %}
            <a class="dropdown-item" href="{% url 'login' %}">Login</a>
            <a class="dropdown-item" href="{% url 'signup' %}">Register</a>
            {% endif %}
          </div>
        </div>
      
        <a class="nav-link text-dark  my-4" href="{% url 'cart' %}"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-cart-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
        </svg> Cart <span class="badge badge-pill badge-primary" id="crtno">0</span></a>
      </div>
      </nav>

      
        
      <div class="container-fluid">
        <div class="d-flex justify-content-center my-4"><h2>SHOPPING CART</h2></div>
        <div class="d-flex justify-content-between mt-5 ml-3">
            <a href="{% url 'collection' %}"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-left" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
              </svg> COTINUE SHOPPING</a>
        </div>
      </div>
        
      <table class="table" id='crt' style="margin-bottom: 100px;">
        <thead class="bg-light mt-2">
          <tr>
            <th scope="col"></th>
            <th scope="col">TITLE</th>
            <th scope="col">QTY</th>
            <th scope="col">PRICE</th>
            <!-- <th scope="col">TOTAL</th> -->
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          

        </tbody>
      </table>

      <div class="d-flex justify-content-end mr-3 mb-3" >
         
        <span>Total:</span>
        <h3 class="ml-2" id="total">0</h3>
               
         </div>
     
      <div class="d-sm-flex justify-content-end mr-2 mb-5">
            
     <a href="#" class="btn btn-primary w-25 ml-auto" id="checkout">PROCEED TO CHECKOUT</a>
            
      </div>

 
  <footer class="zz-footer-detail p-2">
      <div class="d-flex justify-content-between">
       <p class="my-4">&copy; 2010-2020 Privacy-Terms</p>
      <div class="d-flex justify-content-end">
       <img src="{% static 'img/master.png' %}" class="my-4" alt="">
       <img src="{% static 'img/vis.png' %}" class="my-4" alt="">
      </div>
      </div>

    </footer>

<!-- jQuery and JS bundle w/ Popper.js -->
<script src="{% static 'js/jquery-3.5.1.min.js' %}" ></script>
<script src="{% static 'js/bootstrap.bundle.js' %}" ></script>
<script src="{% static 'js/sweetalert2.all.min.js' %}" ></script>
<script type="text/javascript">
$(document).ready(function(){
  var total = [];
  var gTotal;

for (let index = 0; index < localStorage.length; index++) {
 var key = localStorage.key(index);
 var element = localStorage.getItem(key);
 var data = JSON.parse(element);
 var parsedtotal = parseInt(data.price);
 total.push(parsedtotal);
 $('#crt tbody').append('<tr><th scope="row"><img src="'+data.image_url+'" alt="" class="mx-0 my-0 mr-0 ml-0" style="width: 100px; height: 100px;"></th><td>'+data.title +'</td><td>'+data.price +'</td><td>'+data.qty +'</td><td>'+data.price+'</td><td><button class="btn btn-light remove" name="'+data.id+'"><span>&times;</span></button></td></tr>');
  
}

if (localStorage.length == 0) {
  $('#total').text(0);
}else{

gTotal = total.reduce(getTotal)
$('#total').text(gTotal);

}


// come back and resolve this hack 

function getTotal(a, b){
  return a + b
}


$('.remove').on('click', function(){
  $(this).closest('tr').fadeOut('fast');
  var productId = $(this).attr('name');
  localStorage.removeItem(productId);
  
  var cart = localStorage.length;
  var cartid = document.getElementById('crtno');
  cartid.innerText = cart;

  Swal.fire({
  title: 'Item removed sucessfully',
  icon: 'success'
});



});

$('#checkout').on('click', function(e){
  e.preventDefault();
  var customerId = $('#cusid').text();

  if (localStorage.length == 0) {
    Swal.fire({
    title: 'No item in cart',
    icon: 'warning'
});

  }else{

  for (let index = 0; index < localStorage.length; index++) {
  var key = localStorage.key(index);
  var element = localStorage.getItem(key);
  var data = JSON.parse(element);
  var item = {
    'customer': customerId,
    'items':data.id,
    'qty':data.qty
  };

  // var ser_item = item.serialize();

  if (customerId != undefined) {
    var token = '{{csrf_token}}';
    var total = $('#total').text();
    
  $.ajax({
  headers: { "X-CSRFToken": token },
  url:'{% url "addtocart" %}',
  type: 'POST',
  data: item,
  dataType: 'json',
  success: function(response){
    localStorage.clear();
    var res = JSON.parse(response['instance']);
    var order = [];
    var order_data = {
      'cart':res[0].pk,
      'customer_detail':res[0].fields.customer,
      'unpaid': 1,
      'opened': 1,
      'total':total
    };

    $.ajax({
      headers: { "X-CSRFToken": token },
      url:'{% url "create-order" %}',
      type: 'POST',
      data: order_data,
      dataType: 'json',
      success: function(){
        window.location.href="{% url 'checkout' %}"
      },
      error: function(response){
        console.log(response);
      }

    });



  
    
  },
  error: function(response){
    console.log(response);
  }
})


  }else{
    window.location.href="{% url 'checkout' %}"
  }


 
}

  }
});








});



</script>
       
</body>
</html>